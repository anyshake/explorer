#ifndef __FILTER_H
#define __FILTER_H

#include <math.h>
#include <stdint.h>
#include <string.h>

#include "settings.h"

#if ENABLE_COMPENSATION == true
#define LPF_MAG 16.2
#define BPF_MAG 1.17
#define HPF_MAG 1.0

const float LPF_COEFFS[] = {-0.00050126764663757823747847197637, -0.00050053497316263680788628320784, -0.00050636285521019910003948094612, -0.00051743602365063952244067513320, -0.00053183560800261139855926728615, -0.00054704478352273844601882935024, -0.00055996812467523692045251459959, -0.00056696467919077175433989479458, -0.00056389450052465818399166641584, -0.00054617810043627369222252188052, -0.00050886801311826959388212587854, -0.00044673140324018106254305715552, -0.00035434240771220975414410037097, -0.00022618267993201857622709294304, -0.00005674841039355929100387529451, 0.00015933806700776592473432768937, 0.00042721410421556351268493334494, 0.00075166211864652072299763929664, 0.00113699669239310089709216189391, 0.00158695557365365509661092602300, 0.00210459673490723557162662693543, 0.00269220357260610901328767852192, 0.00335120022264498570660484766393, 0.00408207881621648008968472609581, 0.00488434031428750057429732933656, 0.00575645033897523826504905031243, 0.00669581117038730525697909357064, 0.00769875080245050955052299457293, 0.00876052965584552673083962304190, 0.00987536523578321986938099996678, 0.01103647470272754900488809681747, 0.01223613500123700396915449317703, 0.01346575987191761178407567456361, 0.01471599276010345999643469383500, 0.01597681433822719515580601523652, 0.01723766308259437260441693240409, 0.01848756709476038692652188899501, 0.01971528513779861879751109654535, 0.02090945467276110122933907575771, 0.02205874453424813350088662389226, 0.02315200977918467281635450660815, 0.02417844618184322724729895526252, 0.02512774183222761872902317747958, 0.02599022332466652610016843993890, 0.02675699409852485763372520466419, 0.02742006261213320028602424827113, 0.02797245819233285663019117350814, 0.02840833260260802739516350357007, 0.02872304560905269629755842686336, 0.02891323309114238529482499018286, 0.02897685653859441434754273814178, 0.02891323309114238529482499018286, 0.02872304560905269629755842686336, 0.02840833260260802739516350357007, 0.02797245819233286356908507741537, 0.02742006261213320028602424827113, 0.02675699409852485763372520466419, 0.02599022332466652956961539189251, 0.02512774183222761525957622552596, 0.02417844618184323071674590721614, 0.02315200977918467628580145856176, 0.02205874453424813350088662389226, 0.02090945467276110469878602771132, 0.01971528513779861879751109654535, 0.01848756709476038692652188899501, 0.01723766308259437260441693240409, 0.01597681433822719168635906328291, 0.01471599276010345999643469383500, 0.01346575987191760657990524663319, 0.01223613500123700396915449317703, 0.01103647470272755247433504877108, 0.00987536523578321466521057203636, 0.00876052965584552673083962304190, 0.00769875080245051215260820853814, 0.00669581117038730525697909357064, 0.00575645033897523913241078830083, 0.00488434031428750317638254330177, 0.00408207881621648095704646408421, 0.00335120022264498744132832364073, 0.00269220357260610857960680952772, 0.00210459673490723600530749592963, 0.00158695557365365618081309850851, 0.00113699669239310219813476887651, 0.00075166211864652018089655305388, 0.00042721410421556351268493334494, 0.00015933806700776600604949062578, -0.00005674841039355933843772034075, -0.00022618267993201890148774468869, -0.00035434240771220997098453486807, -0.00044673140324018106254305715552, -0.00050886801311826959388212587854, -0.00054617810043627423432360812328, -0.00056389450052465905135340440424, -0.00056696467919077207960054654023, -0.00055996812467523692045251459959, -0.00054704478352273877127948109589, -0.00053183560800261172381991903180, -0.00051743602365063952244067513320, -0.00050636285521019942530013269177, -0.00050053497316263680788628320784, -0.00050126764663757823747847197637};
const float BPF_COEFFS[] = {0.00050929581789406583747920054250, 0.00039254563489589356598680192079, 0.00027758107678476273607465207860, 0.00016461681696639681956630119064, 0.00005584792423996413245545697435, -0.00004354454514711570382737640394, -0.00012487013582579883897404060544, -0.00017604789400428217413345499676, -0.00018245848355679023834741148136, -0.00012853452951967122013139654957, 0.00000000000000000029659058062368, 0.00021342338223083240009159133876, 0.00051510602946507999099629016015, 0.00089872028810878367127007448900, 0.00134592498631407931665437960334, 0.00182487617224701029021438625222, 0.00228987496885324146034257353222, 0.00268238684475642337814993432232, 0.00293355846455594943683609088225, 0.00296822658132668256228403613761, 0.00271026889086045229965149516715, 0.00208900202149794140746297266276, 0.00104620037174760161999276242284, -0.00045679553626560529281872002905, -0.00243247958580004473502778061800, -0.00486170810724836921501434972015, -0.00768994224369847195060811984035, -0.01082570665248774356703709287331, -0.01414163243084670153193460606644, -0.01747827684219863120240745502088, -0.02065070804406593171775874395735, -0.02345762482219907948954862320079, -0.02569256651239804414843526103596, -0.02715657460504451725658014993314, -0.02767151183173747336363490489930, -0.02709314132132295896426832371162, -0.02532302851588032546747975004564, -0.02231835809560409750185172583770, -0.01809885795456514859247398874231, -0.01275018747745888803013514234408, -0.00642336779252087371888668698716, 0.00066990758685896135103676751754, 0.00826596080425733015228928479701, 0.01606141193105524792028582226067, 0.02372838785584565138297996611527, 0.03093176771080830000926198408706, 0.03734741056813246223855529137836, 0.04268021869191324785264285424091, 0.04668087709433787341195554176920, 0.04916017969875278309510591157050, 0.05000000000000000971445146547012, 0.04916017969875278309510591157050, 0.04668087709433787341195554176920, 0.04268021869191324785264285424091, 0.03734741056813246917744919528559, 0.03093176771080830347870893604068, 0.02372838785584565138297996611527, 0.01606141193105525138973277421428, 0.00826596080425732841756580882020, 0.00066990758685896156787720201464, -0.00642336779252087458624842497557, -0.01275018747745888976485861832089, -0.01809885795456515206192094069593, -0.02231835809560409750185172583770, -0.02532302851588032546747975004564, -0.02709314132132296243371527566524, -0.02767151183173746642474100099207, -0.02715657460504451725658014993314, -0.02569256651239803374009440517511, -0.02345762482219907948954862320079, -0.02065070804406593865665264786458, -0.01747827684219862426351355111365, -0.01414163243084670153193460606644, -0.01082570665248774877120752080373, -0.00768994224369847195060811984035, -0.00486170810724837008237608770855, -0.00243247958580004646975125659480, -0.00045679553626560545544904590187, 0.00104620037174760205367363141704, 0.00208900202149794097378210366855, 0.00271026889086045316701323315556, 0.00296822658132668473068838110862, 0.00293355846455595247260217384166, 0.00268238684475642164342645834552, 0.00228987496885324146034257353222, 0.00182487617224701094073568974352, 0.00134592498631408040085655208884, 0.00089872028810878497231268147161, 0.00051510602946508031625694190581, 0.00021342338223083240009159133876, 0.00000000000000000029659058062368, -0.00012853452951967135565666811026, -0.00018245848355679053650300891487, -0.00017604789400428225544861793317, -0.00012487013582579883897404060544, -0.00004354454514711573093243071608, 0.00005584792423996416633677486452, 0.00016461681696639681956630119064, 0.00027758107678476289870497795143, 0.00039254563489589356598680192079, 0.00050929581789406583747920054250};
const float HPF_COEFFS[] = {0.00050126764663757823747847197637, 0.00050053497316263680788628320784, 0.00050636285521019910003948094612, 0.00051743602365063952244067513320, 0.00053183560800261139855926728615, 0.00054704478352273844601882935024, 0.00055996812467523692045251459959, 0.00056696467919077175433989479458, 0.00056389450052465818399166641584, 0.00054617810043627369222252188052, 0.00050886801311826959388212587854, 0.00044673140324018106254305715552, 0.00035434240771220975414410037097, 0.00022618267993201857622709294304, 0.00005674841039355929100387529451, -0.00015933806700776592473432768937, -0.00042721410421556351268493334494, -0.00075166211864652072299763929664, -0.00113699669239310089709216189391, -0.00158695557365365509661092602300, -0.00210459673490723557162662693543, -0.00269220357260610901328767852192, -0.00335120022264498570660484766393, -0.00408207881621648008968472609581, -0.00488434031428750057429732933656, -0.00575645033897523826504905031243, -0.00669581117038730525697909357064, -0.00769875080245050955052299457293, -0.00876052965584552673083962304190, -0.00987536523578321986938099996678, -0.01103647470272754900488809681747, -0.01223613500123700396915449317703, -0.01346575987191761178407567456361, -0.01471599276010345999643469383500, -0.01597681433822719515580601523652, -0.01723766308259437260441693240409, -0.01848756709476038692652188899501, -0.01971528513779861879751109654535, -0.02090945467276110122933907575771, -0.02205874453424813350088662389226, -0.02315200977918467281635450660815, -0.02417844618184322724729895526252, -0.02512774183222761872902317747958, -0.02599022332466652610016843993890, -0.02675699409852485763372520466419, -0.02742006261213320028602424827113, -0.02797245819233285663019117350814, -0.02840833260260802739516350357007, -0.02872304560905269629755842686336, -0.02891323309114238529482499018286, 0.97102314346140561340803287748713, -0.02891323309114238529482499018286, -0.02872304560905269629755842686336, -0.02840833260260802739516350357007, -0.02797245819233286356908507741537, -0.02742006261213320028602424827113, -0.02675699409852485763372520466419, -0.02599022332466652956961539189251, -0.02512774183222761525957622552596, -0.02417844618184323071674590721614, -0.02315200977918467628580145856176, -0.02205874453424813350088662389226, -0.02090945467276110469878602771132, -0.01971528513779861879751109654535, -0.01848756709476038692652188899501, -0.01723766308259437260441693240409, -0.01597681433822719168635906328291, -0.01471599276010345999643469383500, -0.01346575987191760657990524663319, -0.01223613500123700396915449317703, -0.01103647470272755247433504877108, -0.00987536523578321466521057203636, -0.00876052965584552673083962304190, -0.00769875080245051215260820853814, -0.00669581117038730525697909357064, -0.00575645033897523913241078830083, -0.00488434031428750317638254330177, -0.00408207881621648095704646408421, -0.00335120022264498744132832364073, -0.00269220357260610857960680952772, -0.00210459673490723600530749592963, -0.00158695557365365618081309850851, -0.00113699669239310219813476887651, -0.00075166211864652018089655305388, -0.00042721410421556351268493334494, -0.00015933806700776600604949062578, 0.00005674841039355933843772034075, 0.00022618267993201890148774468869, 0.00035434240771220997098453486807, 0.00044673140324018106254305715552, 0.00050886801311826959388212587854, 0.00054617810043627423432360812328, 0.00056389450052465905135340440424, 0.00056696467919077207960054654023, 0.00055996812467523692045251459959, 0.00054704478352273877127948109589, 0.00053183560800261172381991903180, 0.00051743602365063952244067513320, 0.00050636285521019942530013269177, 0.00050053497316263680788628320784, 0.00050126764663757823747847197637};
#endif

#define FIR_NUM_TAPS 101

typedef struct {
    float coeffs[FIR_NUM_TAPS];
    float state[FIR_NUM_TAPS - 1];
} filter_fir_t;

// To filter out low frequency noise lower than 0.2 Hz
// Which is the lowest frequency that can be measured by the geophone
const float PRE_PROC_HPF_COEFFS[][6] = {
    {0.98371517, -1.96743035, 0.98371517, 1.0, -1.97689135, 0.97704745},
    {1.0, -2.0, 1.0, 1.0, -1.99027124, 0.9904284},
};

#define IIR_SOS_SECTIONS 2

typedef struct {
    float sos[IIR_SOS_SECTIONS][6];
    float state[IIR_SOS_SECTIONS][2];
} filter_iir_sos_t;

void filter_fir_apply(filter_fir_t* filter, float* input, uint16_t input_size, float* output);
void apply_data_compensation(int32_t* arr, uint16_t len, filter_fir_t* lowpass_filter, filter_fir_t* bandpass_filter, filter_fir_t* highpass_filter);
void apply_data_pre_processing(int32_t* arr, uint16_t len, filter_iir_sos_t* pre_processing_filter);
void filter_iir_sos_apply(filter_iir_sos_t* filter, float* input, uint16_t input_size, float* output);

#endif
