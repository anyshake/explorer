#ifndef __FILTER_H
#define __FILTER_H

#include <math.h>
#include <stdint.h>
#include <string.h>

#include "settings.h"

#if ENABLE_COMPENSATION == true
#define LPF_MAG 8.0
#define BPF_MAG 1.1
#define HPF_MAG 1.0

const float LPF_COEFFS[] = {0.00036239688399570017200007621128, 0.00037004079754405551101054117069, 0.00037735380199579369965220965177, 0.00038395901596675701111099909824, 0.00038918670248696548641734183072, 0.00039207717358119450979866971174, 0.00039139486964769694063437377451, 0.00038565373278173596801807199164, 0.00037315369427288433727338268220, 0.00035202779374281548911002071023, 0.00032029914801075335664334864383, 0.00027594669905936047805614097506, 0.00021697839959426530533244392718, 0.00014151024853405853257820590230, 0.00004784937377789332300188560043, -0.00006542081838272892824106413689, -0.00019935554371555867857017385614, -0.00035456579641506068105438753690, -0.00053114000741652435833711765056, -0.00072857243893727848156605109153, -0.00094570048502692482129267093072, -0.00118065293082610339552018796638, -0.00143081105493104315286301275734, -0.00169278424229129002484550703400, -0.00196240151313261919699404423056, -0.00223472007128347862139894353106, -0.00250405163877382569426188752004, -0.00276400697933382785004274850849, -0.00300755862885775451798231472367, -0.00322712145402012477723996397572, -0.00341465025946707540632774069422, -0.00356175326803166584013760065375, -0.00365981991597079609271347955257, -0.00370016104489354806864054303617, -0.00367415924212160073872301957465, -0.00357342678945720857927592639669, -0.00338996843381142009404838333353, -0.00311634599809166613904043430239, -0.00274584171239259256652731622239, -0.00227261706798046522054468354668, -0.00169186398268394511471002239489, -0.00099994511766935789513766064118, -0.00019452030239526789823917285460, 0.00072534379436206032620848560555, 0.00175908336668732768158507351330, 0.00290456886549163165525677676726, 0.00415806004944143693669023065240, 0.00551418625822618514026318692345, 0.00696595303471232631803422563621, 0.00850477575295550437817215794212, 0.01012054041773697773964890700427, 0.01180169129783351089635345942952, 0.01353534454956374991074774527533, 0.01530742648937839442413455515180, 0.01710283469442372070168367770293, 0.01890561965789315512775914385202, 0.02069918431090477309308717224212, 0.02246649835325167238186949703049, 0.02419032401946281940485761197124, 0.02585344965095839192548154983342, 0.02743892725529363876835198254867, 0.02893031011387264470058333643010, 0.03031188645300519554637297403588, 0.03156890522124589787411608199363, 0.03268779011856871169472427141045, 0.03365633819856686526073019649630, 0.03446389961052558070786488997328, 0.03510153535946983899274087548292, 0.03556215033338799152984321949589, 0.03584059927079787793990917066367, 0.03593376381060147534141080427617, 0.03584059927079787793990917066367, 0.03556215033338799152984321949589, 0.03510153535946984593163477939015, 0.03446389961052558070786488997328, 0.03365633819856686526073019649630, 0.03268779011856871169472427141045, 0.03156890522124590481300998590086, 0.03031188645300519901581992598949, 0.02893031011387264817003028838371, 0.02743892725529363876835198254867, 0.02585344965095839539492850178704, 0.02419032401946281940485761197124, 0.02246649835325167238186949703049, 0.02069918431090477309308717224212, 0.01890561965789315859720609580563, 0.01710283469442372417113062965655, 0.01530742648937839789358150710541, 0.01353534454956375338019469722894, 0.01180169129783351089635345942952, 0.01012054041773697947437238298107, 0.00850477575295550611289563391892, 0.00696595303471232718539596362461, 0.00551418625822618687498666290026, 0.00415806004944143693669023065240, 0.00290456886549163208893764576146, 0.00175908336668732811526594250751, 0.00072534379436206032620848560555, -0.00019452030239526795244928147888, -0.00099994511766935832881852963538, -0.00169186398268394533155045689199, -0.00227261706798046522054468354668, -0.00274584171239259300020818521659, -0.00311634599809166613904043430239, -0.00338996843381142052772925232773, -0.00357342678945720944663766438509, -0.00367415924212160117240388856885, -0.00370016104489354893600228102457, -0.00365981991597079696007521754098, -0.00356175326803166670749933864215, -0.00341465025946707627368947868263, -0.00322712145402012564460170196412, -0.00300755862885775538534405271207, -0.00276400697933382871740448649689, -0.00250405163877382656162362550845, -0.00223472007128347905507981252526, -0.00196240151313261963067491322477, -0.00169278424229129067536681052530, -0.00143081105493104402022475074574, -0.00118065293082610382920105696058, -0.00094570048502692525497353992492, -0.00072857243893727880682670283718, -0.00053114000741652468359776939621, -0.00035456579641506073526449616118, -0.00019935554371555873278028248041, -0.00006542081838272894179359129296, 0.00004784937377789332300188560043, 0.00014151024853405853257820590230, 0.00021697839959426538664760686359, 0.00027594669905936058647635822361, 0.00032029914801075346506356589238, 0.00035202779374281565174034658305, 0.00037315369427288455411381717930, 0.00038565373278173618485850648874, 0.00039139486964769694063437377451, 0.00039207717358119450979866971174, 0.00038918670248696575746788495209, 0.00038395901596675728216154221961, 0.00037735380199579397070275277315, 0.00037004079754405551101054117069, 0.00036239688399570017200007621128};
const float BPF_COEFFS[] = {-0.00025550884774600918182205222529, -0.00021664647310209089519847380778, -0.00015901453704965029458014147412, -0.00008084050600183814553906930245, 0.00001931487183046083676643545068, 0.00014211232791052605438711364805, 0.00028688348846117361955546098962, 0.00045103617524318740262395666107, 0.00062949459775215135283465972549, 0.00081426378983209097249529317963, 0.00099420869578749587573696100407, 0.00115512902871397994328250824481, 0.00128019135137211843497584418117, 0.00135075076369283071653359940001, 0.00134755814093876868757504450258, 0.00125230797065391166039693970902, 0.00104944008407560564373472988819, 0.00072806995698514545035939793394, 0.00028389079853487154871810593804, -0.00027912993806697883499012835529, -0.00094744368111321982262734708868, -0.00169717834700366899600143533178, -0.00249410940115773333003446055045, -0.00329445147869337172374937239283, -0.00404652192433102748936324388751, -0.00469326147819666347760225733055, -0.00517552547385495380349862415414, -0.00543598683685052579822594154280, -0.00542342582917575925099962219633, -0.00509712680518055200745708432919, -0.00443106463740791482741609996765, -0.00341754735123419271791700424501, -0.00206998987203439472476462768213, -0.00042452788779847119588622961217, 0.00145976003922099347408225522571, 0.00350217253134454953311660574400, 0.00560329891035175279428992567432, 0.00764946692097929342724071943849, 0.00951855103157665978497181669127, 0.01108685773672321919769423459456, 0.01223670721855416899936930263948, 0.01286425447289109465220935391017, 0.01288704439278570354487918336872, 0.01225077945404815481234006568911, 0.01093479853708619574381710748412, 0.00895582154358152623951916382339, 0.00636960470087719835691197900474, 0.00327027109261777537002613414074, -0.00021277702107919634392195484818, -0.00392030206857275301951526458311, -0.00767081056265663495385975778618, -0.01126989647907360517220531903604, -0.01452084467342439760839667428627, -0.01723588634146663162161061677580, -0.01924743101310252141322720831340, -0.02041857449104571980980082912538, -0.02065220262084337121688548677412, -0.01989807685098290632175199732501, -0.01815739608999991996918232928238, -0.01548447425256748583022314846858, -0.01198534531288816470939728731082, -0.00781329675991992815553555118413, -0.00316152580894358192428739151580, 0.00174670224105736757690132687770, 0.00666984997190631177105268889704, 0.01136118260166288536361367533800, 0.01558235538305538167569430640924, 0.01911670481813513081115196712290, 0.02178144351195357777961625345142, 0.02343801842423951301008777647894, 0.02400000000000001090794121694216, 0.02343801842423951301008777647894, 0.02178144351195357777961625345142, 0.01911670481813513428059891907651, 0.01558235538305538167569430640924, 0.01136118260166288536361367533800, 0.00666984997190631263841442688545, 0.00174670224105736779374176137480, -0.00316152580894358235796826051001, -0.00781329675991992989025902716094, -0.01198534531288816470939728731082, -0.01548447425256748756494662444538, -0.01815739608999992343862928123599, -0.01989807685098290632175199732501, -0.02065220262084337121688548677412, -0.02041857449104572327924778107899, -0.01924743101310252488267416026702, -0.01723588634146663509105756872941, -0.01452084467342440107784362623988, -0.01126989647907360517220531903604, -0.00767081056265663755594497175139, -0.00392030206857275388687700257151, -0.00021277702107919637102700916031, 0.00327027109261777623738787212915, 0.00636960470087719835691197900474, 0.00895582154358152623951916382339, 0.01093479853708619921326405943773, 0.01225077945404815481234006568911, 0.01288704439278570874904961129914, 0.01286425447289109812165630586378, 0.01223670721855417246881625459309, 0.01108685773672322093241771057137, 0.00951855103157666151969529266808, 0.00764946692097929342724071943849, 0.00560329891035175452901340165113, 0.00350217253134454996679747473820, 0.00145976003922099390776312421991, -0.00042452788779847130430644686072, -0.00206998987203439515844549667634, -0.00341754735123419358527874223341, -0.00443106463740791656213957594446, -0.00509712680518055287481882231759, -0.00542342582917576098572309817314, -0.00543598683685052753294941751960, -0.00517552547385495553822210013095, -0.00469326147819666521232573330735, -0.00404652192433102835672498187591, -0.00329445147869337302479197937544, -0.00249410940115773463107706753306, -0.00169717834700366986336317332018, -0.00094744368111322025630821608289, -0.00027912993806697894341034560384, 0.00028389079853487171134843181086, 0.00072806995698514566719983243104, 0.00104944008407560586057516438530, 0.00125230797065391209407780870322, 0.00134755814093876868757504450258, 0.00135075076369283071653359940001, 0.00128019135137211908549714767247, 0.00115512902871398037696337723901, 0.00099420869578749630941782999827, 0.00081426378983209129775594492529, 0.00062949459775215167809531147114, 0.00045103617524318767367449978245, 0.00028688348846117361955546098962, 0.00014211232791052605438711364805, 0.00001931487183046085031896260675, -0.00008084050600183818619665077065, -0.00015901453704965040300035872267, -0.00021664647310209089519847380778, -0.00025550884774600918182205222529};
const float HPF_COEFFS[] = {-0.00036239688399570017200007621128, -0.00037004079754405551101054117069, -0.00037735380199579369965220965177, -0.00038395901596675701111099909824, -0.00038918670248696548641734183072, -0.00039207717358119450979866971174, -0.00039139486964769694063437377451, -0.00038565373278173596801807199164, -0.00037315369427288433727338268220, -0.00035202779374281548911002071023, -0.00032029914801075335664334864383, -0.00027594669905936047805614097506, -0.00021697839959426530533244392718, -0.00014151024853405853257820590230, -0.00004784937377789332300188560043, 0.00006542081838272892824106413689, 0.00019935554371555867857017385614, 0.00035456579641506068105438753690, 0.00053114000741652435833711765056, 0.00072857243893727848156605109153, 0.00094570048502692482129267093072, 0.00118065293082610339552018796638, 0.00143081105493104315286301275734, 0.00169278424229129002484550703400, 0.00196240151313261919699404423056, 0.00223472007128347862139894353106, 0.00250405163877382569426188752004, 0.00276400697933382785004274850849, 0.00300755862885775451798231472367, 0.00322712145402012477723996397572, 0.00341465025946707540632774069422, 0.00356175326803166584013760065375, 0.00365981991597079609271347955257, 0.00370016104489354806864054303617, 0.00367415924212160073872301957465, 0.00357342678945720857927592639669, 0.00338996843381142009404838333353, 0.00311634599809166613904043430239, 0.00274584171239259256652731622239, 0.00227261706798046522054468354668, 0.00169186398268394511471002239489, 0.00099994511766935789513766064118, 0.00019452030239526789823917285460, -0.00072534379436206032620848560555, -0.00175908336668732768158507351330, -0.00290456886549163165525677676726, -0.00415806004944143693669023065240, -0.00551418625822618514026318692345, -0.00696595303471232631803422563621, -0.00850477575295550437817215794212, -0.01012054041773697773964890700427, -0.01180169129783351089635345942952, -0.01353534454956374991074774527533, -0.01530742648937839442413455515180, -0.01710283469442372070168367770293, -0.01890561965789315512775914385202, -0.02069918431090477309308717224212, -0.02246649835325167238186949703049, -0.02419032401946281940485761197124, -0.02585344965095839192548154983342, -0.02743892725529363876835198254867, -0.02893031011387264470058333643010, -0.03031188645300519554637297403588, -0.03156890522124589787411608199363, -0.03268779011856871169472427141045, -0.03365633819856686526073019649630, -0.03446389961052558070786488997328, -0.03510153535946983899274087548292, -0.03556215033338799152984321949589, -0.03584059927079787793990917066367, 0.96406623618939857323084652307443, -0.03584059927079787793990917066367, -0.03556215033338799152984321949589, -0.03510153535946984593163477939015, -0.03446389961052558070786488997328, -0.03365633819856686526073019649630, -0.03268779011856871169472427141045, -0.03156890522124590481300998590086, -0.03031188645300519901581992598949, -0.02893031011387264817003028838371, -0.02743892725529363876835198254867, -0.02585344965095839539492850178704, -0.02419032401946281940485761197124, -0.02246649835325167238186949703049, -0.02069918431090477309308717224212, -0.01890561965789315859720609580563, -0.01710283469442372417113062965655, -0.01530742648937839789358150710541, -0.01353534454956375338019469722894, -0.01180169129783351089635345942952, -0.01012054041773697947437238298107, -0.00850477575295550611289563391892, -0.00696595303471232718539596362461, -0.00551418625822618687498666290026, -0.00415806004944143693669023065240, -0.00290456886549163208893764576146, -0.00175908336668732811526594250751, -0.00072534379436206032620848560555, 0.00019452030239526795244928147888, 0.00099994511766935832881852963538, 0.00169186398268394533155045689199, 0.00227261706798046522054468354668, 0.00274584171239259300020818521659, 0.00311634599809166613904043430239, 0.00338996843381142052772925232773, 0.00357342678945720944663766438509, 0.00367415924212160117240388856885, 0.00370016104489354893600228102457, 0.00365981991597079696007521754098, 0.00356175326803166670749933864215, 0.00341465025946707627368947868263, 0.00322712145402012564460170196412, 0.00300755862885775538534405271207, 0.00276400697933382871740448649689, 0.00250405163877382656162362550845, 0.00223472007128347905507981252526, 0.00196240151313261963067491322477, 0.00169278424229129067536681052530, 0.00143081105493104402022475074574, 0.00118065293082610382920105696058, 0.00094570048502692525497353992492, 0.00072857243893727880682670283718, 0.00053114000741652468359776939621, 0.00035456579641506073526449616118, 0.00019935554371555873278028248041, 0.00006542081838272894179359129296, -0.00004784937377789332300188560043, -0.00014151024853405853257820590230, -0.00021697839959426538664760686359, -0.00027594669905936058647635822361, -0.00032029914801075346506356589238, -0.00035202779374281565174034658305, -0.00037315369427288455411381717930, -0.00038565373278173618485850648874, -0.00039139486964769694063437377451, -0.00039207717358119450979866971174, -0.00038918670248696575746788495209, -0.00038395901596675728216154221961, -0.00037735380199579397070275277315, -0.00037004079754405551101054117069, -0.00036239688399570017200007621128};
#endif

#define FIR_NUM_TAPS 141

typedef struct {
    float coeffs[FIR_NUM_TAPS];
    float state[FIR_NUM_TAPS - 1];
} filter_fir_t;

// To filter out low frequency noise lower than 0.1 Hz
// Which is the lowest frequency that can be measured by the geophone
const float PRE_PROC_HPF_COEFFS[][6] = {
    {0.99182421, -1.98364842, 0.99182421, 1.0, -1.98841802, 0.98845727},
    {1.0, -2.0, 1.0, 1.0, -1.99516324, 0.99520262},
};

#define IIR_SOS_SECTIONS 2

typedef struct {
    float sos[IIR_SOS_SECTIONS][6];
    float state[IIR_SOS_SECTIONS][2];
} filter_iir_sos_t;

void filter_fir_apply(filter_fir_t* filter, float* input, uint16_t input_size, float* output);
void apply_data_compensation(int32_t* arr, uint16_t len, filter_fir_t* lowpass_filter, filter_fir_t* bandpass_filter, filter_fir_t* highpass_filter);
void apply_data_pre_processing(int32_t* arr, uint16_t len, filter_iir_sos_t* pre_processing_filter);
void filter_iir_sos_apply(filter_iir_sos_t* filter, float* input, uint16_t input_size, float* output);

#endif
